local TweenService = game:GetService("TweenService")  -- เรียกใช้ TweenService
local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local StartButton = Instance.new("TextButton")
local IncreaseButton = Instance.new("TextButton")
local DecreaseButton = Instance.new("TextButton")
local TimeLabel = Instance.new("TextLabel")
local DestroyButton = Instance.new("TextButton")  -- ปุ่มใหม่สำหรับทำลาย GUI
local SkillMenuButton = Instance.new("TextButton")  -- ปุ่มเปิดเมนูเลือกสกิล
local SkillMenuFrame = Instance.new("Frame")  -- กรอบเมนูเลือกสกิล
local CurrentSkill = ""  -- ตัวแปรเก็บสกิลที่กำลังใช้
local isSkillActive = false  -- ตัวแปรเช็คว่า สกิลกำลังทำงานอยู่หรือไม่
local skillTimer = 1.0  -- เวลาเริ่มต้นของสกิล (เป็นวินาที)
local skillCoroutine = nil  -- ใช้ในการจัดการ Coroutine ของการทำงานของสกิล

-- ตั้งชื่อ GUI และเพิ่มเข้าไปใน CoreGui
ScreenGui.Name = "CustomSkillGui"
ScreenGui.Parent = game.CoreGui

-- ตั้งค่ากรอบหลัก (ขนาดแคบลง)
MainFrame.Parent = ScreenGui
MainFrame.Size = UDim2.new(0, 250, 0, 180)  -- ทำให้ MainFrame แคบลงมากขึ้น
MainFrame.Position = UDim2.new(1, -260, 0.5, -90)  -- ปรับตำแหน่งให้สวยงามขึ้น
MainFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
MainFrame.Active = true -- ทำให้สามารถลากได้
MainFrame.Draggable = true -- เปิดใช้งานการลาก

-- ปุ่มเริ่ม/หยุด (ลดขนาด)
StartButton.Parent = MainFrame
StartButton.Size = UDim2.new(0, 220, 0, 30)  -- ลดขนาดปุ่มเริ่ม
StartButton.Position = UDim2.new(0, 15, 0, 10)
StartButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
StartButton.Text = "Select Skill"
StartButton.TextSize = 14
StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)

-- ปุ่มเพิ่มเวลา (ลดขนาด)
IncreaseButton.Parent = MainFrame
IncreaseButton.Size = UDim2.new(0, 105, 0, 30)  -- ลดขนาดปุ่มเพิ่มเวลา
IncreaseButton.Position = UDim2.new(0, 15, 0, 50)
IncreaseButton.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
IncreaseButton.Text = "+ Time"
IncreaseButton.TextSize = 14
IncreaseButton.TextColor3 = Color3.fromRGB(255, 255, 255)

-- ปุ่มลดเวลา (ลดขนาด)
DecreaseButton.Parent = MainFrame
DecreaseButton.Size = UDim2.new(0, 105, 0, 30)  -- ลดขนาดปุ่มลดเวลา
DecreaseButton.Position = UDim2.new(0, 130, 0, 50)
DecreaseButton.BackgroundColor3 = Color3.fromRGB(200, 0, 100)
DecreaseButton.Text = "- Time"
DecreaseButton.TextSize = 14
DecreaseButton.TextColor3 = Color3.fromRGB(255, 255, 255)

-- แสดงเวลาปัจจุบัน (ลดขนาด)
TimeLabel.Parent = MainFrame
TimeLabel.Size = UDim2.new(0, 220, 0, 25)  -- ลดขนาด TimeLabel
TimeLabel.Position = UDim2.new(0, 15, 0, 90)
TimeLabel.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
TimeLabel.Text = "Skill Interval: 1.0s"
TimeLabel.TextSize = 14
TimeLabel.TextColor3 = Color3.fromRGB(255, 255, 255)

-- ปุ่มทำลาย GUI (ย้ายไปขวาบน)
DestroyButton.Parent = ScreenGui  -- เปลี่ยนให้เป็น ScreenGui แทน MainFrame
DestroyButton.Size = UDim2.new(0, 30, 0, 30)  -- ขนาดปุ่มทำลายเล็กลง
DestroyButton.Position = UDim2.new(1, -35, 0, 10)  -- ตำแหน่งขวาบน
DestroyButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
DestroyButton.Text = "X"  -- เปลี่ยนชื่อปุ่มเป็น "X"
DestroyButton.TextSize = 16
DestroyButton.TextColor3 = Color3.fromRGB(255, 255, 255)

-- ปุ่มเปิดเมนูเลือกสกิล (ลดขนาด)
SkillMenuButton.Parent = MainFrame
SkillMenuButton.Size = UDim2.new(0, 220, 0, 30)  -- ลดขนาดปุ่มเลือกสกิล
SkillMenuButton.Position = UDim2.new(0, 15, 0, 130)
SkillMenuButton.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
SkillMenuButton.Text = "Select Skill"
SkillMenuButton.TextSize = 14
SkillMenuButton.TextColor3 = Color3.fromRGB(0, 0, 0)

-- กรอบเมนูเลือกสกิล (ใช้ ScrollingFrame) (ลดขนาด)
local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Parent = MainFrame
ScrollFrame.Size = UDim2.new(0, 220, 0, 70)  -- ลดขนาด ScrollFrame
ScrollFrame.Position = UDim2.new(0, 15, 0, 160)
ScrollFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)  -- ขนาดเนื้อหาที่จะเลื่อน
ScrollFrame.ScrollBarThickness = 8
ScrollFrame.VerticalScrollBarPosition = Enum.VerticalScrollBarPosition.Left
ScrollFrame.Visible = false  -- ซ่อน ScrollFrame ในตอนเริ่มต้น

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Parent = ScrollFrame
UIListLayout.Padding = UDim.new(0, 4)  -- ระยะห่างระหว่างปุ่ม

-- ฟังก์ชันโหลดปุ่มสกิล
local function loadSkillButtons()
    -- ลบปุ่มทั้งหมดใน ScrollFrame
    for _, button in pairs(ScrollFrame:GetChildren()) do
        if button:IsA("TextButton") then
            button:Destroy()
        end
    end

    -- ดึงข้อมูลสกิลจาก ReplicatedStorage
    local playerAbilities = game:GetService("ReplicatedStorage"):WaitForChild("PlayerAbilities")

    -- สร้างปุ่มสำหรับสกิลทุกตัว
    for _, ability in pairs(playerAbilities:GetChildren()) do
        local skillButton = Instance.new("TextButton")
        skillButton.Parent = ScrollFrame
        skillButton.Size = UDim2.new(0, 200, 0, 30)  -- ลดขนาดปุ่มสกิล
        skillButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
        skillButton.Text = ability.Name
        skillButton.TextSize = 14
        skillButton.TextColor3 = Color3.fromRGB(255, 255, 255)

        -- เมื่อคลิกปุ่มให้เลือกสกิลนั้น
        skillButton.MouseButton1Click:Connect(function()
            CurrentSkill = ability.Name
            StartButton.Text = "Start " .. CurrentSkill .. " Skill"
            ScrollFrame.Visible = false  -- ซ่อนเมนูหลังเลือกสกิล
            print("Current Skill: " .. CurrentSkill)
        end)
    end

    -- อัพเดตขนาดของ CanvasSize ให้พอดีกับจำนวนปุ่มที่เพิ่มขึ้น
    ScrollFrame.CanvasSize = UDim2.new(0, 0, 0, #playerAbilities:GetChildren() * 40)  -- 40 คือความสูงของแต่ละปุ่ม
end

-- ฟังก์ชันเปิด/ปิดเมนูเลือกสกิล
SkillMenuButton.MouseButton1Click:Connect(function()
    -- โหลดปุ่มสกิลใหม่ทุกครั้งที่เปิดเมนู
    loadSkillButtons()

    -- สลับสถานะการแสดงเมนู
    ScrollFrame.Visible = not ScrollFrame.Visible

    -- ทำอนิเมชันเมื่อเปิด/ปิดเมนู
    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    local goal = {Size = ScrollFrame.Visible and UDim2.new(0, 220, 0, 70) or UDim2.new(0, 0, 0, 70)}
    local tween = TweenService:Create(ScrollFrame, tweenInfo, goal)
    tween:Play()
end)

-- ฟังก์ชันเริ่ม/หยุดการทำงานของสกิล
StartButton.MouseButton1Click:Connect(function()
    if isSkillActive then
        -- หยุดการทำงานของสกิล
        isSkillActive = false
        StartButton.Text = "Start " .. CurrentSkill .. " Skill"  -- เปลี่ยนข้อความปุ่มกลับ
        if skillCoroutine then
            coroutine.close(skillCoroutine)  -- หยุด Coroutine ของการทำงานของสกิล
        end
    else
        -- เริ่มการทำงานของสกิล
        if CurrentSkill == "" then
            print("No skill selected!")
            return
        end

        -- สั่งให้สกิลทำงาน
        isSkillActive = true
        StartButton.Text = "Stop " .. CurrentSkill .. " Skill"  -- เปลี่ยนข้อความปุ่ม

        -- ฟังก์ชันที่ทำงานซ้ำ
        skillCoroutine = coroutine.create(function()
            while isSkillActive do
                -- สั่งให้สกิลทำงาน
                local args = {
                    [1] = game:GetService("ReplicatedStorage"):WaitForChild("PlayerAbilities"):WaitForChild(CurrentSkill)
                }
                game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Ability"):FireServer(unpack(args))

                -- รอเวลาที่กำหนดแล้วทำงานต่อ
                wait(skillTimer)
            end
        end)
        coroutine.resume(skillCoroutine)
    end
end)

-- ฟังก์ชันปรับเวลา
IncreaseButton.MouseButton1Click:Connect(function()
    skillTimer = skillTimer + 0.5  -- เพิ่มเวลาเป็น 0.5 วินาที
    TimeLabel.Text = "Skill Interval: " .. string.format("%.1f", skillTimer) .. "s"
end)

DecreaseButton.MouseButton1Click:Connect(function()
    if skillTimer > 0.5 then
        skillTimer = skillTimer - 0.5  -- ลดเวลาเป็น 0.5 วินาที
        TimeLabel.Text = "Skill Interval: " .. string.format("%.1f", skillTimer) .. "s"
    end
end)

-- ฟังก์ชันลบ GUI
DestroyButton.MouseButton1Click:Connect(function()
    -- ทำอนิเมชันให้ปุ่ม Destroy ก่อนจะทำลาย GUI
    local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Circular, Enum.EasingDirection.Out)
    local goal = {BackgroundColor3 = Color3.fromRGB(0, 0, 0)}
    local tween = TweenService:Create(DestroyButton, tweenInfo, goal)
    tween:Play()

    tween.Completed:Connect(function()
        -- ทำลาย GUI ทั้งหมด
        ScreenGui:Destroy()  -- ลบ ScreenGui ทิ้ง
        print("GUI Destroyed!")
    end)
end)
